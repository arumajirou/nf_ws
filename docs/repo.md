nf_loto_platform 機能拡張・改修 引継ぎ資料作成日: 2025-06-10対象: 開発チーム / AIエンジニア1. 改修の目的と概要本改修は、nf_loto_platform の自律的な予測能力を向上させるため、以下の3つの課題に対処しました。Plannerの柔軟性向上: ユーザーフラグだけでなく、データ特性（量・トレンド・季節性）に応じてモデルを動的に推奨するロジックへの移行。RAGのコンテキスト制約対策: 過去の類似パターンをLLMに入力する際のトークン枯渇を防ぐため、時系列データの圧縮と要約機能を実装。ビジネス視点の評価導入: 単なる誤差（MAE）だけでなく、方向正解率やドローダウンなどのビジネス指標を導入し、Reflection Agentの批評能力を強化。2. モジュール別変更点詳細2.1 Planner Agent (動的モデル選択)ファイル: src/nf_loto_platform/agents/planner_agent.py変更内容:従来: allow_tsfm 等のフラグによる単純なフィルタリング。改修後: _score_models メソッドを追加。データ量 (n_obs)、季節性強度、トレンド強度に基づき、各モデルにスコアを付与してソート順を決定します。ロジックの要点:データ少 (<1000) → TSFM (Zero-shot) を優先。季節性強 (>0.6) → NHITS, TFT などを優先。トレンド強 (>0.6) → DLinear などを優先。2.2 RAG Agent (コンテキスト圧縮・要約)ファイル: src/nf_loto_platform/agents/rag_agent.py変更内容:時系列圧縮 (_compress_sequence): 長い時系列データを平均プーリングにより指定長（デフォルト64）に圧縮し、トークン消費を削減。要約レポート (generate_rag_report): 検索された類似パターンの統計（上昇確率など）を計算し、LLMに「自然言語のヒント」を生成させる機能を追加。設定: config/agent_config.yaml 内の compressed_sequence_length で圧縮率を調整可能。2.3 Reflection Agent & Metrics (多面的評価)ファイル:src/nf_loto_platform/agents/reflection_agent.pysrc/nf_loto_platform/ml_analysis/metrics.pysrc/nf_loto_platform/ml/model_runner.py変更内容:新規メトリクス: Directional Accuracy (方向正解率), Max Drawdown, Sharpe Ratio, Coverage Error を実装。Runner: 実験終了時に上記メトリクスを自動計算し、meta 情報に格納するよう修正。Prompt Engineering: Reflection Agentがこれらの指標を参照し、「精度は良いが方向が逆」といったリスクを指摘できるようにプロンプトを改修。3. 追加されたファイル一覧パス役割src/nf_loto_platform/ml_analysis/metrics.pyビジネス・リスク指標の計算ロジック定義tests/agents/test_rag_agent.pyRAGの圧縮・要約機能のユニットテストtests/agents/test_planner_agent.pyデータ特性に基づく動的プランニングのテスト※ その他、既存の model_runner.py, planner_agent.py, reflection_agent.py に修正を加えています。4. 動作確認・テスト方法改修箇所の動作を検証するために、以下のテストを実行してください。4.1 ユニットテストの実行# 全テストの実行
pytest tests/

# エージェント関連の特定テスト
pytest tests/agents/test_planner_agent.py
pytest tests/agents/test_rag_agent.py
pytest tests/agents/test_reflection_agent.py # (もしあれば)
4.2 期待される挙動の確認ポイントPlanner: データ量が少ないモックデータを与えた際、TSFM系モデルが推奨リストの上位に来ること。RAG: 検索結果に含まれる長い配列が、指定した長さ（例: 64）に圧縮されて返ってくること。Runner: 実験完了後のログや戻り値 (meta["metrics"]) に directional_accuracy 等が含まれていること。5. 今後の課題 (残タスク)LLMプロンプトのチューニング:RAG Agentが生成する要約レポートの品質は、使用するLLMモデルに依存します。より具体的な予測ヒントを出力できるよう、プロンプトの改善が必要です。圧縮アルゴリズムの高度化:現在は単純な平均プーリングですが、重要なピーク（極大値・極小値）を保存する Piecewise Aggregate Approximation (PAA) などの導入を検討してください。UIへの反映:WebUI (Streamlit) 上で、追加されたビジネス指標（方向正解率など）をグラフやテーブルで可視化する改修が別途必要です。以上