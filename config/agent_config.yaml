# config/agent_config.yaml
# AI Agent Configuration for NeuralForecast AutoML Platform
# ============================================================================

# ----------------------------------------------------------------------------
# LLM Provider Settings
# ----------------------------------------------------------------------------
llm:
  default_provider: "openai"
  default_model: "gpt-4o"
  timeout_seconds: 60
  
  # モデルごとの詳細設定
  models:
    gpt-4o:
      temperature: 0.1
      max_tokens: 4096
      top_p: 0.95
    
    gpt-4-turbo:
      temperature: 0.2
      max_tokens: 4096
    
    # コスト節約用の軽量モデル
    gpt-3.5-turbo:
      temperature: 0.0
      max_tokens: 2048

# ----------------------------------------------------------------------------
# Agent Definitions
# ----------------------------------------------------------------------------
agents:
  # 1. データ分析エージェント: データの特性を把握し、異常やトレンドを言語化する
  analyst:
    name: "TimeSeriesAnalyst"
    role: "Senior Data Analyst specialized in Time Series"
    goal: >
      入力された時系列データの統計的特性（トレンド、季節性、定常性、欠損、外れ値）を詳細に分析し、
      予測モデルの選択に資する洞察を提供する。
    system_prompt: |
      あなたは熟練した時系列データアナリストです。
      与えられたデータセットの記述統計、ヒストグラム、自己相関などを分析し、以下の点を報告してください：
      1. データの全体的な傾向（上昇/下降トレンド、ランダムウォークなど）
      2. 季節性や周期性の有無（週次、月次など）
      3. 異常値や構造変化点（Change Points）の存在
      4. データに含まれるノイズのレベル
      
      あなたの出力は、後続の Planner Agent が最適なモデルを選択するための根拠として使用されます。
      具体的かつ定量的な根拠に基づいて分析してください。
    
    allowed_tools:
      - "describe_dataset"
      - "plot_decomposition"
      - "check_stationarity"
      - "detect_anomalies"

  # 2. RAGエージェント: 過去の類似パターンを検索し、文脈情報を提供する
  rag:
    name: "PatternRetriever"
    role: "Historical Pattern Matcher"
    goal: >
      現在の直近データと類似した過去の当選パターンや波形をデータベースから検索し、
      その後の挙動（正解データ）をヒントとして提供する。
    system_prompt: |
      あなたは膨大な過去データを持つ検索スペシャリストです。
      現在の入力系列（クエリ）に対して、形状や統計的特徴が類似している過去の区間を検索してください。
      検索結果は「類似度スコア」と共に提示し、
      「過去に同様のパターンの後でどのような値が出現したか」を要約してください。
      
      特にロト/ナンバーズのようなデータでは、完全な一致よりも「出現パターンの類似性」に注目してください。
    
    config:
      vector_db_collection: "loto_history_vectors"
      top_k: 5
      similarity_threshold: 0.75
    
    allowed_tools:
      - "search_similar_patterns"
      - "get_historical_context"

  # 3. 戦略立案エージェント: 分析結果とRAG情報を元に、実行設定を決定する
  planner:
    name: "ExperimentPlanner"
    role: "Lead Machine Learning Engineer"
    goal: >
      Analystの分析結果とRAGの文脈情報を統合し、最も精度が期待できるモデル、
      ハイパーパラメータ探索空間、および損失関数を決定する。
    system_prompt: |
      あなたはNeuralForecastとTSFM（Time Series Foundation Models）のエキスパートです。
      Analystからのデータ特性報告と、RAGからの過去事例に基づいて、以下の戦略を立案してください：
      
      1. 使用するモデル（例: トレンドが強いならNHITS、複雑な依存関係があるならTFT、データが少ないならTime-MoE Zero-shot）
      2. 探索バックエンド（Optuna vs Ray vs TSFM Zero-shot）
      3. 損失関数（外れ値が多いならHuberLoss、分位点予測が必要ならMQLoss）
      4. 重要なハイパーパラメータ（input_size, learning_rate等）の探索範囲
      
      出力はJSON形式の `optimization_config` として生成してください。
    
    allowed_tools:
      - "list_available_models"
      - "get_model_specs"
      - "generate_config_json"

  # 4. 振り返りエージェント: 実行結果を評価し、改善案を出す
  reflection:
    name: "ResultReflector"
    role: "Quality Assurance & Optimization Specialist"
    goal: >
      実行された実験のメトリクス（MAE, MSE, Coverage）を評価し、
      Conformal Predictionの信頼区間が適切か、過学習していないかを診断する。
    system_prompt: |
      あなたは予測システムの品質保証担当です。
      実験結果のメトリクスと予測プロットを確認し、以下の観点で批評（Reflection）を行ってください：
      
      1. 精度は許容範囲内か？（ベースラインと比較して優れているか）
      2. 予測区間（Conformal Interval）は実際の値を適切にカバーしているか？
      3. 過学習（Train Loss << Val Loss）や未学習の兆候はないか？
      4. 次回の実験に向けた具体的な改善提案（例: 「input_sizeを長くする」「ドロップアウトを増やす」）
      
      あなたのフィードバックはデータベースに記録され、次回のPlannerの意思決定に利用されます。
    
    allowed_tools:
      - "get_experiment_metrics"
      - "calculate_coverage_error"
      - "compare_with_baseline"

# ----------------------------------------------------------------------------
# Orchestration Settings
# ----------------------------------------------------------------------------
orchestrator:
  max_iterations: 3        # 自律改善ループの最大回数
  stop_on_success: true    # 目標精度に達したら停止するか
  human_in_the_loop: false # 実行前に人間の承認を求めるか
  
  # エージェント間のデータの受け渡しフォーマット
  context_compression: true # 長いコンテキストを要約して渡すか